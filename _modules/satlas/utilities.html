<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>satlas.utilities &mdash; SATLAS 0.1.0b11 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0b11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/copybutton.js"></script>
    <link rel="top" title="SATLAS 0.1.0b11 documentation" href="../../index.html" >
    <link rel="up" title="Module code" href="../index.html" > 
  </head>
  <body>

  <div class="container">
    <div class="header">
    </div>
  </div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../../index.html">SATLAS 0.1.0b11 documentation</a></li>
	
          <li class="active"><a href="../index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for satlas.utilities</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementation of various functions that ease the work, but do not belong in one of the other modules.</span>

<span class="sd">.. moduleauthor:: Wouter Gins &lt;wouter.gins@fys.kuleuven.be&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">emcee</span> <span class="kn">as</span> <span class="nn">mcmc</span>
<span class="kn">import</span> <span class="nn">lmfit</span> <span class="kn">as</span> <span class="nn">lm</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">tqdm</span>

<span class="n">c</span> <span class="o">=</span> <span class="mf">299792458.0</span>
<span class="n">h</span> <span class="o">=</span> <span class="mf">6.62606957</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="mi">34</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="mf">1.60217657</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="mi">19</span><span class="p">)</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span><span class="s">&#39;#A6CEE3&#39;</span><span class="p">,</span> <span class="s">&#39;#1F78B4&#39;</span><span class="p">,</span> <span class="s">&#39;#B2DF8A&#39;</span><span class="p">])</span>
<span class="n">cmap</span><span class="o">.</span><span class="n">set_over</span><span class="p">(</span><span class="s">&#39;#A6CEE3&#39;</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="s">&#39;#B2DF8A&#39;</span><span class="p">)</span>
<span class="n">invcmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span><span class="s">&#39;#B2DF8A&#39;</span><span class="p">,</span> <span class="s">&#39;#1F78B4&#39;</span><span class="p">,</span> <span class="s">&#39;#A6CEE3&#39;</span><span class="p">])</span>
<span class="n">invcmap</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="s">&#39;#A6CEE3&#39;</span><span class="p">)</span>
<span class="n">invcmap</span><span class="o">.</span><span class="n">set_over</span><span class="p">(</span><span class="s">&#39;#B2DF8A&#39;</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;weighted_average&#39;</span><span class="p">,</span>
           <span class="s">&#39;generate_correlation_map&#39;</span><span class="p">,</span>
           <span class="s">&#39;generate_correlation_plot&#39;</span><span class="p">,</span>
           <span class="s">&#39;generate_spectrum&#39;</span><span class="p">,</span>
           <span class="s">&#39;poisson_interval&#39;</span><span class="p">,</span>
           <span class="s">&#39;load_model&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="weighted_average"><a class="viewcode-back" href="../../utilities/satlas.utilities.weighted_average.html#satlas.utilities.weighted_average">[docs]</a><span class="k">def</span> <span class="nf">weighted_average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;Takes the weighted average of an array of values and the associated</span>
<span class="sd">    errors. Calculates the scatter and statistical error, and returns</span>
<span class="sd">    the greater of these two values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array_like</span>
<span class="sd">        Array-like assortment of measured values, is transformed into a</span>
<span class="sd">        1D-array.</span>
<span class="sd">    sigma: array_like</span>
<span class="sd">        Array-like assortment of errors on the measured values, is transformed</span>
<span class="sd">        into a 1D-array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Returns a tuple (weighted_average, uncertainty), with the uncertainty</span>
<span class="sd">        being the greater of the uncertainty calculated from the statistical</span>
<span class="sd">        uncertainty and the scattering uncertainty.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The formulas used are</span>

<span class="sd">    .. math::</span>

<span class="sd">        \left\langle x\right\rangle_{weighted} &amp;= \frac{\sum_{i=1}^N \frac{x_i}</span>
<span class="sd">                                                                 {\sigma_i^2}}</span>
<span class="sd">                                                      {\sum_{i=1}^N \frac{1}</span>
<span class="sd">                                                                {\sigma_i^2}}</span>

<span class="sd">        \sigma_{stat}^2 &amp;= \frac{1}{\sum_{i=1}^N \frac{1}{\sigma_i^2}}</span>

<span class="sd">        \sigma_{scatter}^2 &amp;= \frac{\sum_{i=1}^N \left(\frac{x_i-\left\langle</span>
<span class="sd">                                                    x\right\rangle_{weighted}}</span>
<span class="sd">                                                      {\sigma_i}\right)^2}</span>
<span class="sd">               {\left(N-1\right)\sum_{i=1}^N \frac{1}{\sigma_i^2}}&quot;&quot;&quot;</span>
    <span class="c"># x = np.ravel(x)</span>
    <span class="c"># sigma = np.ravel(sigma)</span>
    <span class="n">Xstat</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">Xm</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="o">/</span> <span class="n">Xstat</span>
    <span class="c"># Xscatt = (((x - Xm) / sigma)**2).sum() / ((1 - 1.0 / len(x)) * Xstat)</span>
    <span class="n">Xscatt</span> <span class="o">=</span> <span class="p">(((</span><span class="n">x</span> <span class="o">-</span> <span class="n">Xm</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Xstat</span><span class="p">)</span>
    <span class="n">Xstat</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Xstat</span>
    <span class="k">return</span> <span class="n">Xm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">Xstat</span><span class="p">,</span> <span class="n">Xscatt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
</div>
<span class="k">def</span> <span class="nf">_make_axes_grid</span><span class="p">(</span><span class="n">no_variables</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cbar_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">axis_padding</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a triangular grid of axes, with a colorbar axis next to it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    no_variables: int</span>
<span class="sd">        Number of variables for which to generate a figure.</span>
<span class="sd">    padding: float</span>
<span class="sd">        Padding around the figure (in cm).</span>
<span class="sd">    cbar_size: float</span>
<span class="sd">        Width of the colorbar (in cm).</span>
<span class="sd">    axis_padding: float</span>
<span class="sd">        Padding between axes (in cm).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, axes, cbar: tuple</span>
<span class="sd">        Tuple containing the figure, a 2D-array of axes and the colorbar axis.&quot;&quot;&quot;</span>

    <span class="c"># Convert to inches.</span>
    <span class="n">padding</span><span class="p">,</span> <span class="n">cbar_size</span><span class="p">,</span> <span class="n">axis_padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">padding</span> <span class="o">*</span> <span class="mf">0.393700787</span><span class="p">,</span>
                                        <span class="n">cbar_size</span> <span class="o">*</span> <span class="mf">0.393700787</span><span class="p">,</span>
                                        <span class="n">axis_padding</span> <span class="o">*</span> <span class="mf">0.393700787</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cbar</span><span class="p">:</span>
        <span class="n">cbar_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># Generate the figure, convert padding to percentages.</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">axis_size</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">axis_size</span> <span class="o">*</span> <span class="n">no_variables</span> <span class="o">+</span> <span class="n">cbar_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">no_variables</span> <span class="o">*</span> <span class="n">axis_padding</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">axis_size</span> <span class="o">*</span> <span class="n">no_variables</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span>
    <span class="k">if</span> <span class="n">no_variables</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">+=</span> <span class="p">(</span><span class="n">no_variables</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">axis_padding</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">cbar_size</span> <span class="o">=</span> <span class="n">cbar_size</span> <span class="o">/</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span>
    <span class="n">left_padding</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">/</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span>
    <span class="n">left_axis_padding</span> <span class="o">=</span> <span class="n">axis_padding</span> <span class="o">/</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span>
    <span class="n">up_padding</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">/</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span>
    <span class="n">up_axis_padding</span> <span class="o">=</span> <span class="n">axis_padding</span> <span class="o">/</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span>
    <span class="n">axis_size_left</span> <span class="o">=</span> <span class="n">axis_size</span> <span class="o">/</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span>
    <span class="n">axis_size_up</span> <span class="o">=</span> <span class="n">axis_size</span> <span class="o">/</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span>

    <span class="c"># Pre-allocate a 2D-array to hold the axes.</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variables</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_variables</span><span class="p">)],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;object&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">I</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">no_variables</span><span class="p">),</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">no_variables</span><span class="p">))):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">no_variables</span><span class="p">)):</span>
            <span class="c"># Only create axes on the lower triangle.</span>
            <span class="k">if</span> <span class="n">I</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">no_variables</span><span class="p">:</span>
                <span class="c"># Share the x-axis with the plot on the diagonal,</span>
                <span class="c"># directly above the plot.</span>
                <span class="n">sharex</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="k">else</span> <span class="bp">None</span>
                <span class="c"># Share the y-axis among the 2D maps along one row,</span>
                <span class="c"># but not the plot on the diagonal!</span>
                <span class="n">sharey</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">j</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
                <span class="c"># Determine the place and size of the axes</span>
                <span class="n">left_edge</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">axis_size_left</span> <span class="o">+</span> <span class="n">left_padding</span>
                <span class="n">bottom_edge</span> <span class="o">=</span> <span class="n">I</span> <span class="o">*</span> <span class="n">axis_size_up</span> <span class="o">+</span> <span class="n">up_padding</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">left_edge</span> <span class="o">+=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">left_axis_padding</span>
                <span class="k">if</span> <span class="n">I</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bottom_edge</span> <span class="o">+=</span> <span class="n">I</span> <span class="o">*</span> <span class="n">up_axis_padding</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="n">left_edge</span><span class="p">,</span> <span class="n">bottom_edge</span><span class="p">,</span> <span class="n">axis_size_left</span><span class="p">,</span> <span class="n">axis_size_up</span><span class="p">],</span>
                             <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">left_edge</span> <span class="o">=</span> <span class="n">no_variables</span><span class="o">*</span><span class="p">(</span><span class="n">axis_size_left</span><span class="o">+</span><span class="n">left_axis_padding</span><span class="p">)</span><span class="o">+</span><span class="n">left_padding</span>
    <span class="n">bottom_edge</span> <span class="o">=</span> <span class="n">up_padding</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">cbar_size</span>

    <span class="n">height</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">up_padding</span>

    <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="n">left_edge</span><span class="p">,</span> <span class="n">bottom_edge</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">cbar</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">cbar</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">cbar</span>

<div class="viewcode-block" id="generate_correlation_map"><a class="viewcode-back" href="../../utilities/satlas.utilities.generate_correlation_map.html#satlas.utilities.generate_correlation_map">[docs]</a><span class="k">def</span> <span class="nf">generate_correlation_map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;chisquare&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resolution_diag</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">resolution_map</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fit_kws</span><span class="o">=</span><span class="p">{},</span> <span class="n">distance</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a correlation map for either the chisquare or the MLE method.</span>
<span class="sd">    On the diagonal, the chisquare or loglikelihood is drawn as a function of one fixed parameter.</span>
<span class="sd">    Refitting to the data each time gives the points on the line. A dashed line is drawn on these</span>
<span class="sd">    plots, with the intersection with the plots giving the correct confidence interval for the</span>
<span class="sd">    parameter. In solid lines, the interval estimated by the fitting routine is drawn.</span>
<span class="sd">    On the offdiagonal, two parameters are fixed and the model is again fitted to the data.</span>
<span class="sd">    The change in chisquare/loglikelihood is mapped to 1, 2 and 3 sigma contourmaps.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f: :class:`.BaseModel`</span>
<span class="sd">        Instance of the model for which the contour map has to be generated.</span>
<span class="sd">    x_data: array_like or list of array_likes</span>
<span class="sd">        Data on the x-axis for the fit. Must be appropriate input for *f*.</span>
<span class="sd">    y_data: array_like or list of array_likes</span>
<span class="sd">        Data on the y-axis for the fit. Must be appropriate input for *f*.</span>

<span class="sd">    Other parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    method: {&#39;chisquare&#39;, &#39;mle&#39;}</span>
<span class="sd">        Chooses between generating the map for the chisquare routine or for</span>
<span class="sd">        the likelihood routine.</span>
<span class="sd">    filter: list of strings</span>
<span class="sd">        Only the parameters matching the names given in this list will be used</span>
<span class="sd">        to generate the maps.</span>
<span class="sd">    resolution_diag: int</span>
<span class="sd">        Number of points for the line plot on each diagonal.</span>
<span class="sd">    resolution_map: int</span>
<span class="sd">        Number of points along each dimension for the meshgrids.</span>
<span class="sd">    fit_kws: dictionary</span>
<span class="sd">        Dictionary of keywords to pass on to the fitting routine.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fitting</span>

    <span class="k">def</span> <span class="nf">fit_new_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">params_name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">orig_value</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">orig_value</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">params_name</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">params</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">orig_value</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">params</span><span class="p">[</span><span class="n">params_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">params</span><span class="p">[</span><span class="n">params_name</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">-</span> <span class="n">orig_value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">params_name</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params_name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">params_name</span> <span class="o">+</span> <span class="s">&#39; (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">return_value</span>

    <span class="c"># Save the original goodness-of-fit and parameters for later use</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;chisquare&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">fitting</span><span class="o">.</span><span class="n">chisquare_spectroscopic_fit</span><span class="p">,</span> <span class="s">&#39;chisqr&#39;</span><span class="p">),</span>
               <span class="s">&#39;mle&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">fitting</span><span class="o">.</span><span class="n">likelihood_fit</span><span class="p">,</span> <span class="s">&#39;mle_likelihood&#39;</span><span class="p">)}</span>
    <span class="n">func</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="p">(</span><span class="n">fitting</span><span class="o">.</span><span class="n">chisquare_spectroscopic_fit</span><span class="p">,</span> <span class="s">&#39;chisqr&#39;</span><span class="p">))</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s">r&#39;{} = ${:.2f}_{{-{:.2f}}}^{{+{:.2f}}}$&#39;</span>
    <span class="n">fit_kws</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">func</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>

    <span class="n">orig_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="n">orig_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="n">ranges</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># Select all variable parameters, generate the figure</span>
    <span class="n">param_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">no_params</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">orig_params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">filter</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">f</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">])):</span>
            <span class="n">no_params</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">cbar</span> <span class="o">=</span> <span class="n">_make_axes_grid</span><span class="p">(</span><span class="n">no_params</span><span class="p">,</span> <span class="n">axis_padding</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="n">no_params</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c"># Make the plots on the diagonal: plot the chisquare/likelihood</span>
    <span class="c"># for the best fitting values while setting one parameter to</span>
    <span class="c"># a fixed value.</span>
    <span class="n">saved_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_params</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">saved_params</span><span class="p">)</span>
        <span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># orig_value = getattr(f, attr)</span>
        <span class="c"># orig_params = copy.deepcopy(f.params)</span>
        <span class="c"># res = fit_new_value(f.params[param_names[i]].value, f, f.params, param_names[i], x_data, y_data, orig_value, func)</span>
        <span class="c"># orig_value += res</span>
        <span class="c"># Set the y-ticklabels.</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;chisquare&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\Delta\chi^2$&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\Delta\mathcal{L}$&#39;</span><span class="p">)</span>

        <span class="c"># Select starting point to determine error widths.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ori_value</span> <span class="o">=</span> <span class="n">orig_value</span><span class="c"># + fit_new_value(value, f, params, param_names[i], x_data, y_data, orig_value, func) - (1 - 0.5*(method.lower() == &#39;mle&#39;))</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span> <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">value</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span> <span class="k">if</span> <span class="n">stderr</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">value</span>
        <span class="c"># Search for a value to the right which gives an increase greater than 1.</span>
        <span class="n">search_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">leave</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (searching right)&#39;</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">search_value</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">stderr</span>
                <span class="k">if</span> <span class="n">search_value</span> <span class="o">&gt;</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (right limit reached)&#39;</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">search_value</span> <span class="o">=</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span>
                    <span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s">&#39;right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">search_value</span>
                    <span class="k">break</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">fit_new_value</span><span class="p">(</span><span class="n">search_value</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">ori_value</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;mle&#39;</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (searching right: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">search_value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (finding root)&#39;</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">fit_new_value</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;mle&#39;</span><span class="p">)),</span>
                                             <span class="n">value</span><span class="p">,</span> <span class="n">search_value</span><span class="p">,</span>
                                             <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">ori_value</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (root found: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s">&#39;right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                    <span class="k">break</span>
        <span class="n">search_value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c"># Do the same for the left</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">leave</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (searching left)&#39;</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">search_value</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">stderr</span>
                <span class="k">if</span> <span class="n">search_value</span> <span class="o">&lt;</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (left limit reached)&#39;</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">search_value</span> <span class="o">=</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span>
                    <span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s">&#39;left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">search_value</span>
                    <span class="k">break</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">fit_new_value</span><span class="p">(</span><span class="n">search_value</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">ori_value</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (searching left: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_value</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;mle&#39;</span><span class="p">):</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (searching root)&#39;</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">fit_new_value</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;mle&#39;</span><span class="p">)),</span>
                                           <span class="n">value</span><span class="p">,</span> <span class="n">search_value</span><span class="p">,</span>
                                           <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">ori_value</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (root found: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s">&#39;left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                    <span class="k">break</span>

        <span class="c"># Keep the parameter fixed, and let it vary (with given number of points)</span>
        <span class="c"># in a deviation of 4 sigma in both directions.</span>
        <span class="c"># middle = (ranges[param_names[i]][&#39;left&#39;] + ranges[param_names[i]][&#39;right&#39;]) * 0.5</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s">&#39;right&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s">&#39;left&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">left_val</span><span class="p">,</span> <span class="n">right_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">left</span><span class="p">,</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">right</span><span class="p">,</span> <span class="n">orig_params</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
        <span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s">&#39;right_val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">right_val</span>
        <span class="n">ranges</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s">&#39;left_val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_val</span>
        <span class="n">value_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">left_val</span><span class="p">,</span> <span class="n">right_val</span><span class="p">,</span> <span class="n">resolution_diag</span><span class="p">)</span>
        <span class="n">chisquare</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value_range</span><span class="p">))</span>
        <span class="c"># Calculate the new value, and store it in the array. Update the progressbar.</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">value_range</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">leave</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value_range</span><span class="p">):</span>
                <span class="n">chisquare</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_new_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                             <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">ori_value</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># Plot the result</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">value_range</span><span class="p">,</span> <span class="n">chisquare</span><span class="p">)</span>

        <span class="c"># For chisquare, an increase of 1 corresponds to 1 sigma errorbars.</span>
        <span class="c"># For the loglikelihood, this need to be reduced by a factor of 2.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;mle&#39;</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s">&quot;dashed&quot;</span><span class="p">)</span>
        <span class="c"># Indicate the used interval.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>
        <span class="c"># Restore the parameters.</span>
        <span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">orig_params</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tril_indices_from</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">orig_params</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">x_name</span> <span class="o">=</span> <span class="n">param_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">y_name</span> <span class="o">=</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">no_params</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_name</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">x_name</span><span class="p">][</span><span class="s">&#39;right_val&#39;</span><span class="p">]</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">x_name</span><span class="p">][</span><span class="s">&#39;left_val&#39;</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="n">x_name</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">resolution_map</span><span class="p">)</span>

        <span class="n">right</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">y_name</span><span class="p">][</span><span class="s">&#39;right_val&#39;</span><span class="p">]</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">y_name</span><span class="p">][</span><span class="s">&#39;left_val&#39;</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="n">y_name</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">resolution_map</span><span class="p">)</span>

        <span class="n">ori_value</span> <span class="o">=</span> <span class="n">orig_value</span> <span class="o">+</span> <span class="n">fit_new_value</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="n">x_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">y_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="p">[</span><span class="n">x_name</span><span class="p">,</span> <span class="n">y_name</span><span class="p">],</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">orig_value</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">i_indices</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="n">param_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">leave</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">i_indices</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">j_indices</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
                <span class="n">Z</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_new_value</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="p">[</span><span class="n">x_name</span><span class="p">,</span> <span class="n">y_name</span><span class="p">],</span>
                                        <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">ori_value</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># pbar.finish()</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="o">-</span><span class="n">Z</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;mle&#39;</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">]</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">invcmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="n">contourset</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">invcmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">orig_params</span>
        <span class="n">func</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contourset</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">r&#39;3$\sigma$&#39;</span><span class="p">,</span> <span class="s">r&#39;2$\sigma$&#39;</span><span class="p">,</span> <span class="s">r&#39;1$\sigma$&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">cbar</span>
</div>
<span class="k">def</span> <span class="nf">_diaconis_rule</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">):</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">]))</span>
    <span class="n">bin_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iqr</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">bin_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">minimum</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bin_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bin_size</span> <span class="o">&lt;</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">minimum</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">minimum</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">minimum</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>

<div class="viewcode-block" id="generate_correlation_plot"><a class="viewcode-back" href="../../utilities/satlas.utilities.generate_correlation_plot.html#satlas.utilities.generate_correlation_plot">[docs]</a><span class="k">def</span> <span class="nf">generate_correlation_plot</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given the random walk data, creates a triangle plot: distribution of</span>
<span class="sd">    a single parameter on the diagonal axes, 2D contour plots with 1, 2 and</span>
<span class="sd">    3 sigma contours on the off-diagonal. The 1-sigma limits based on the</span>
<span class="sd">    percentile method are also indicated, as well as added to the title.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: string</span>
<span class="sd">        Filename for the h5 file containing the data from the walk.</span>
<span class="sd">    filter: list of str, optional</span>
<span class="sd">        If supplied, only this list of columns is used for the plot.</span>
<span class="sd">    bins: int or list of int, optional</span>
<span class="sd">        If supplied, use this number of bins for the plotting.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    figure</span>
<span class="sd">        Returns the MatPlotLib figure created.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;format&#39;</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">filter</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">cbar</span> <span class="o">=</span> <span class="n">_make_axes_grid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">),</span> <span class="n">axis_padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="n">bins</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">filter</span><span class="p">):</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">bin_index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="n">bin_index</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># bins[bin_index] = _diaconis_rule(x, x.min(), x.max())</span>
                    <span class="n">bins</span><span class="p">[</span><span class="n">bin_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_index</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="mi">50</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;bins&#39;</span><span class="p">:</span> <span class="n">bins</span><span class="p">[</span><span class="n">bin_index</span><span class="p">],</span> <span class="s">&#39;min&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="s">&#39;max&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()}</span>

                <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="mf">16.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">84.0</span><span class="p">]</span>
                <span class="n">q16</span><span class="p">,</span> <span class="n">q50</span><span class="p">,</span> <span class="n">q84</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

                <span class="n">title</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="s">r&#39; = ${:.2f}_{{-{:.2f}}}^{{+{:.2f}}}$&#39;</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q50</span><span class="p">,</span> <span class="n">q50</span><span class="o">-</span><span class="n">q16</span><span class="p">,</span> <span class="n">q84</span><span class="o">-</span><span class="n">q50</span><span class="p">))</span>
                <span class="n">qvalues</span> <span class="o">=</span> <span class="p">[</span><span class="n">q16</span><span class="p">,</span> <span class="n">q50</span><span class="p">,</span> <span class="n">q84</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qvalues</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&quot;dashed&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tril_indices_from</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">x_name</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">y_name</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">x_name</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">y_name</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">filter</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">filter</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x_name</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y_name</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_bins</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">x_name</span><span class="p">][</span><span class="s">&#39;min&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="n">x_name</span><span class="p">][</span><span class="s">&#39;max&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="n">x_name</span><span class="p">][</span><span class="s">&#39;bins&#39;</span><span class="p">]</span>
                <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">y_bins</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">y_name</span><span class="p">][</span><span class="s">&#39;min&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="n">y_name</span><span class="p">][</span><span class="s">&#39;max&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="n">y_name</span><span class="p">][</span><span class="s">&#39;bins&#39;</span><span class="p">]</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">y_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">H</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">),</span>
                                         <span class="n">weights</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">Y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">H</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">H</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

                <span class="n">Hflat</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Hflat</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Hflat</span> <span class="o">=</span> <span class="n">Hflat</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>
                <span class="n">sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Hflat</span><span class="p">)</span>
                <span class="n">sm</span> <span class="o">/=</span> <span class="n">sm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">levels</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hflat</span><span class="p">[</span><span class="n">sm</span> <span class="o">&lt;=</span> <span class="n">v0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hflat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">H</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">V</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">invcmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

                <span class="n">contourset</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">invcmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contourset</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">r&#39;3$\sigma$&#39;</span><span class="p">,</span> <span class="s">r&#39;2$\sigma$&#39;</span><span class="p">,</span> <span class="s">r&#39;1$\sigma$&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">cbar</span>
</div>
<div class="viewcode-block" id="generate_spectrum"><a class="viewcode-back" href="../../utilities/satlas.utilities.generate_spectrum.html#satlas.utilities.generate_spectrum">[docs]</a><span class="k">def</span> <span class="nf">generate_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">number_of_counts</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a model by random sampling from the provided :class:`.HFSModel`</span>
<span class="sd">    and range. The total number of counts for the generated spectrum</span>
<span class="sd">    is required.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrum: :class:`.HFSModel`</span>
<span class="sd">        An instance of class:`.HFSModel`, which gives the probability distribution</span>
<span class="sd">        from which the random samples are drawn.</span>
<span class="sd">    x: NumPy array</span>
<span class="sd">        NumPy array representing the bin centers for the spectrum.</span>
<span class="sd">    number_of_counts: int</span>
<span class="sd">        Parameter controlling the total number of counts in the spectrum.</span>
<span class="sd">    nwalkers: int, optional</span>
<span class="sd">        Number of walkers for the random sampling algorithm from emcee.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y: NumPy array</span>
<span class="sd">        Array containing the number of counts corresponding to each value</span>
<span class="sd">        in x.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">binsize</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c"># Need the binsize for accurate lnprob boundaries</span>

    <span class="k">def</span> <span class="nf">lnprob</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">right</span> <span class="o">+</span> <span class="n">binsize</span> <span class="o">/</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">left</span> <span class="o">-</span> <span class="n">binsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c"># Make sure only to draw from the provided range</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">spectrum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c"># No need to normalize lnprob!</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
           <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="c"># Burn-in</span>
    <span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="c"># Making sure not to do too much work! Divide requested number of samples</span>
    <span class="c"># by number of walkers, make sure it&#39;s a higher integer.</span>
    <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">number_of_counts</span> <span class="o">/</span> <span class="n">nwalkers</span><span class="p">))</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">flatchain</span><span class="p">[</span><span class="o">-</span><span class="n">number_of_counts</span><span class="p">:]</span>
    <span class="c"># Bin the samples</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">binsize</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">binsize</span><span class="p">)</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</div>
<div class="viewcode-block" id="poisson_interval"><a class="viewcode-back" href="../../utilities/satlas.utilities.poisson_interval.html#satlas.utilities.poisson_interval">[docs]</a><span class="k">def</span> <span class="nf">poisson_interval</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the confidence interval</span>
<span class="sd">    for the mean of a Poisson distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: array_like</span>
<span class="sd">        Data giving the mean of the Poisson distributions.</span>
<span class="sd">    alpha: float</span>
<span class="sd">        Significance level of interval. Defaults to</span>
<span class="sd">        one sigma (0.32).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    low, high: array_like</span>
<span class="sd">        Lower and higher limits for the interval.&quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span>
</div>
<div class="viewcode-block" id="load_model"><a class="viewcode-back" href="../../utilities/satlas.utilities.load_model.html#satlas.utilities.load_model">[docs]</a><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads the saved BaseModel and returns the reconstructed object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: string</span>
<span class="sd">        Location of the saved model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: BaseModel</span>
<span class="sd">        Saved BaseModel/child class instance.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2015, Wouter Gins.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>